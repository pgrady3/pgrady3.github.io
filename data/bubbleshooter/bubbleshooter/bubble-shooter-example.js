function PRAXEndExperience(){console.log("Ending PRAX experience"),window.vuplex&&window.vuplex.postMessage({type:"test_result",message:""})}window.onload=function(){function e(){D.parentElement,window.innerWidth;var e=window.innerHeight;H=e/G,D.width=F,D.height=G,D.style.width=F*H+"px",D.style.height=G*H+"px",D.style.display="block",D.style.marginLeft="auto",D.style.marginRight="auto",D.style.marginTop="0",z.imageSmoothingEnabled=!1}function t(e){fe=0,ye=e.length,ce=!1;for(var t=[],i=0;i<e.length;i++){var l=new Image;l.onload=function(){++fe==ye&&(ce=!0)},l.src=e[i],t[i]=l}return t}function i(){ue=t(["bubbleshooter/bubble-sprites.png"]),ne=ue[0],D.addEventListener("mousemove",W),D.addEventListener("mousedown",q);for(var e=0;e<J.columns;e++){J.tiles[e]=[];for(var i=0;i<J.rows;i++)J.tiles[e][i]=new K(e,i,0,0)}J.width=J.columns*J.tilewidth+J.tilewidth/2,J.height=D.height-J.rowheight-J.tileheight,N.x=J.x+J.width/2-J.tilewidth/2,N.y=J.y+J.height+10,N.angle=90,N.tiletype=0,N.nextbubble.x=N.x-2*J.tilewidth,N.nextbubble.y=N.y,le=0,oe=!1,k(),l(0)}function l(e){window.requestAnimationFrame(l),j?(r(e),w()):(z.clearRect(0,0,D.width,D.height),ce&&setTimeout(function(){j=!0},10))}function r(e){var t=(e-O)/1e3;O=e,v(t),oe||(le+=t)>=re&&(oe=!0,PRAXEndExperience()),$==Z.ready||($==Z.shootbubble?o(t):$==Z.removecluster&&h(t))}function n(e){$=e,he=0}function o(e){if(N.bubble.x+=e*N.bubble.speed*Math.cos(V(N.bubble.angle)),N.bubble.y+=e*N.bubble.speed*-1*Math.sin(V(N.bubble.angle)),N.bubble.x<=J.x?(N.bubble.angle=180-N.bubble.angle,N.bubble.x=J.x):N.bubble.x+J.tilewidth>=J.x+J.width&&(N.bubble.angle=180-N.bubble.angle,N.bubble.x=J.x+J.width-J.tilewidth),N.bubble.y<=J.y)return N.bubble.y=J.y,void a();for(var t=0;t<J.columns;t++)for(var i=0;i<J.rows;i++){if(!(J.tiles[t][i].type<0)){var l=E(t,i);if(X(N.bubble.x+J.tilewidth/2,N.bubble.y+J.tileheight/2,J.radius,l.tilex+J.tilewidth/2,l.tiley+J.tileheight/2,J.radius))return void a()}}}function h(e){if(0==he){g();for(var t=0;t<be.length;t++)be[t].removed=!0;if(ee+=100*be.length,(se=y()).length>0)for(t=0;t<se.length;t++)for(var i=0;i<se[t].length;i++){(r=se[t][i]).shift=0,r.shift=1,r.velocity=N.bubble.dropspeed,ee+=100}he=1}if(1==he){var l=!1;for(t=0;t<be.length;t++){(r=be[t]).type>=0&&(l=!0,r.alpha-=15*e,r.alpha<0&&(r.alpha=0),0==r.alpha&&(r.type=-1,r.alpha=1))}for(t=0;t<se.length;t++)for(i=0;i<se[t].length;i++){var r;(r=se[t][i]).type>=0&&(l=!0,r.velocity+=700*e,r.shift+=e*r.velocity,r.alpha-=8*e,r.alpha<0&&(r.alpha=0),(0==r.alpha||r.y*J.rowheight+r.shift>(J.rows-1)*J.rowheight+J.tileheight)&&(r.type=-1,r.shift=0,r.alpha=1))}if(!l){I();var o=!1;for(t=0;t<J.columns;t++)for(i=0;i<J.rows;i++)if(-1!=J.tiles[t][i].type){o=!0;break}n(o?Z.ready:Z.gameover)}}}function a(){var e=S(N.bubble.x+J.tilewidth/2,N.bubble.y+J.tileheight/2);e.x<0&&(e.x=0),e.x>=J.columns&&(e.x=J.columns-1),e.y<0&&(e.y=0),e.y>=J.rows&&(e.y=J.rows-1);var t=!1;if(-1!=J.tiles[e.x][e.y].type){for(var i=e.y+1;i<J.rows;i++)if(-1==J.tiles[e.x][i].type){e.y=i,t=!0;break}}else t=!0;if(t){if(N.bubble.visible=!1,J.tiles[e.x][e.y].type=N.bubble.tiletype,b())return;if((be=f(e.x,e.y,!0,!0,!1)).length>=3)return void n(Z.removecluster)}++te>=5&&(s(),te=0,ie=(ie+1)%2,b())||(I(),n(Z.ready))}function b(){for(var e=0;e<J.columns;e++)if(-1!=J.tiles[e][J.rows-1].type)return I(),n(Z.gameover),!0;return!1}function s(){for(var e=0;e<J.columns;e++)for(var t=0;t<J.rows-1;t++)J.tiles[e][J.rows-1-t].type=J.tiles[e][J.rows-1-t-1].type;for(e=0;e<J.columns;e++)J.tiles[e][0].type=L()}function u(){for(var e=[],t=[],i=0;i<U;i++)t.push(!1);for(i=0;i<J.columns;i++)for(var l=0;l<J.rows;l++){var r=J.tiles[i][l];r.type>=0&&(t[r.type]||(t[r.type]=!0,e.push(r.type)))}return e}function f(e,t,i,l,r){l&&c();var n=J.tiles[e][t],o=[n];n.processed=!0;for(var h=[];o.length>0;){var a=o.pop();if(-1!=a.type&&!(r&&a.removed||i&&a.type!=n.type)){h.push(a);for(var b=d(a),s=0;s<b.length;s++)b[s].processed||(o.push(b[s]),b[s].processed=!0)}}return h}function y(){c();for(var e=[],t=0;t<J.columns;t++)for(var i=0;i<J.rows;i++){if(!J.tiles[t][i].processed){var l=f(t,i,!1,!1,!0);if(l.length<=0)continue;for(var r=!0,n=0;n<l.length;n++)if(0==l[n].y){r=!1;break}r&&e.push(l)}}return e}function c(){for(var e=0;e<J.columns;e++)for(var t=0;t<J.rows;t++)J.tiles[e][t].processed=!1}function g(){for(var e=0;e<J.columns;e++)for(var t=0;t<J.rows;t++)J.tiles[e][t].removed=!1}function d(e){for(var t=(e.y+ie)%2,i=[],l=Q[t],r=0;r<l.length;r++){var n=e.x+l[r][0],o=e.y+l[r][1];n>=0&&n<J.columns&&o>=0&&o<J.rows&&i.push(J.tiles[n][o])}return i}function v(e){Y>.25&&(Math.round(_/Y),Y=0,_=0),Y+=e,_++}function p(e,t,i,l){var r=z.measureText(e);z.fillText(e,t+(l-r.width)/2,i)}function w(){var e=J.tileheight/2,t=D.height;z.fillStyle="#8c8c8c",z.fillRect(J.x-4,J.y,J.width+8,t),x(),z.fillStyle="#656565",z.fillRect(J.x-4,J.y+J.height+12-e,J.width+8,2*J.tileheight+3),z.fillStyle="#ffffff",z.font="18px Verdana";var i=J.x+J.width-150,l=J.y+J.height+J.tileheight-e-8;if(p("Score:",i,l,150),z.font="24px Verdana",p(ee,i,l+30,150),ae){m(be,255,128,128);for(var r=0;r<se.length;r++){var n=Math.floor(100+100*r/se.length);m(se[r],n,n,n)}}M(),$==Z.gameover&&(z.fillStyle="rgba(0, 0, 0, 0.8)",z.fillRect(J.x-4,J.y-4,J.width+8,J.height+2*J.tileheight+8-e),z.fillStyle="#ffffff",z.font="24px Verdana",p("Game Over!",J.x,J.y+J.height/2+10,J.width),p("Click to start",J.x,J.y+J.height/2+40,J.width))}function x(){for(var e=0;e<J.rows;e++)for(var t=0;t<J.columns;t++){var i=J.tiles[t][e],l=i.shift,r=E(t,e);i.type>=0&&(z.save(),z.globalAlpha=i.alpha,R(r.tilex,r.tiley+l,i.type),z.restore())}}function m(e,t,i,l){for(var r=0;r<e.length;r++){var n=E(e[r].x,e[r].y);z.fillStyle="rgb("+t+","+i+","+l+")",z.fillRect(n.tilex+J.tilewidth/4,n.tiley+J.tileheight/4,J.tilewidth/2,J.tileheight/2)}}function M(){var e=N.x+J.tilewidth/2,t=N.y+J.tileheight/2;z.fillStyle="#7a7a7a",z.beginPath(),z.arc(e,t,J.radius+12,0,2*Math.PI,!1),z.fill(),z.lineWidth=2,z.strokeStyle="#8c8c8c",z.stroke(),z.lineWidth=2,z.strokeStyle="#0000ff",z.setLineDash([5,5]),z.beginPath(),z.moveTo(e,t),z.lineTo(e+2.5*J.tilewidth*Math.cos(V(N.angle)),t-2.5*J.tileheight*Math.sin(V(N.angle))),z.stroke(),z.setLineDash([]),R(N.nextbubble.x,N.nextbubble.y,N.nextbubble.tiletype),N.bubble.visible&&R(N.bubble.x,N.bubble.y,N.bubble.tiletype)}function E(e,t){var i=J.x+e*J.tilewidth;return(t+ie)%2&&(i+=J.tilewidth/2),{tilex:i,tiley:J.y+t*J.rowheight}}function S(e,t){var i=Math.floor((t-J.y)/J.rowheight),l=0;return(i+ie)%2&&(l=J.tilewidth/2),{x:Math.floor((e-l-J.x)/J.tilewidth),y:i}}function R(e,t,i){i<0||i>=U||z.drawImage(ne,40*i,0,40,40,e,t,J.tilewidth,J.tileheight)}function k(){ee=0,te=0,ie=0,n(Z.ready),P(),I(),I()}function P(){for(var e=0;e<J.rows;e++)for(var t=T(0,U-1),i=0,l=0;l<J.columns;l++){if(i>=2){var r=T(0,U-1);r==t&&(r=(r+1)%U),t=r,i=0}i++,e<J.rows/2?J.tiles[l][e].type=t:J.tiles[l][e].type=-1}}function I(){N.tiletype=N.nextbubble.tiletype,N.bubble.tiletype=N.nextbubble.tiletype,N.bubble.x=N.x,N.bubble.y=N.y,N.bubble.visible=!0;var e=L();N.nextbubble.tiletype=e}function L(){existingcolors=u();var e=0;return existingcolors.length>0&&(e=existingcolors[T(0,existingcolors.length-1)]),e}function T(e,t){return Math.floor(e+Math.random()*(t-e+1))}function A(){N.bubble.x=N.x,N.bubble.y=N.y,N.bubble.angle=N.angle,N.bubble.tiletype=N.tiletype,n(Z.shootbubble)}function X(e,t,i,l,r,n){var o=e-l,h=t-r;return Math.sqrt(o*o+h*h)<i+n}function C(e){return e*(180/Math.PI)}function V(e){return e*(Math.PI/180)}function W(e){var t=B(D,e),i=C(Math.atan2(N.y+J.tileheight/2-t.y,t.x-(N.x+J.tilewidth/2)));i<0&&(i=180+(180+i));var l=8,r=172;i>90&&i<270?i>r&&(i=r):(i<l||i>=270)&&(i=l),N.angle=i}function q(e){B(D,e);$==Z.ready?A():$==Z.gameover&&k()}function B(e,t){var i=e.getBoundingClientRect();return{x:Math.round((t.clientX-i.left)/(i.right-i.left)*e.width),y:Math.round((t.clientY-i.top)/(i.bottom-i.top)*e.height)}}var D=document.getElementById("viewport"),z=D.getContext("2d"),F=628,G=628,H=1;e(),window.addEventListener("resize",e);var O=0,Y=0,_=0,j=!1,J={x:4,y:0,width:0,height:0,columns:15,rows:14,tilewidth:40,tileheight:40,rowheight:34,radius:20,tiles:[]},K=function(e,t,i,l){this.x=e,this.y=t,this.type=i,this.removed=!1,this.shift=l,this.velocity=0,this.alpha=1,this.processed=!1},N={x:0,y:0,angle:0,tiletype:0,bubble:{x:0,y:0,angle:0,speed:1e3,dropspeed:900,tiletype:0,visible:!1},nextbubble:{x:0,y:0,tiletype:0}},Q=[[[1,0],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1]],[[1,0],[1,1],[0,1],[-1,0],[0,-1],[1,-1]]],U=5,Z={init:0,ready:1,shootbubble:2,removecluster:3,gameover:4},$=Z.init,ee=0,te=0,ie=0,le=0;const re=120;var ne,oe=!1,he=0,ae=!1,be=[],se=[],ue=[],fe=0,ye=0,ce=!1;i()};