"use strict";function makeDimension(t,e,n,i,s,r){return{width:t,height:e,innerWidth:t-(r+i),innerHeight:e-(n+s),top:n,right:i,bottom:s,left:r,cx:(t-(r+i))/2+r,cy:(e-(n+s))/2+n}}function rHit(t,e){return plotHitsDimension.innerWidth/2/e*t}function resetTrialData(){isMoving=!1,dragCount=0,clearTimeout(stopTimeout),console.log("Trial data reset. Drag count is now 0.")}function createRenderedCursor(){testAreaSVG.selectAll("#rendered-cursor").remove(),testAreaSVG.append("circle").attr("id","rendered-cursor").attr("r",5).attr("fill","blue").attr("opacity",.7).attr("cx",0).attr("cy",0).style("pointer-events","none")}function updateRenderedCursor(){const t=Date.now()-cursorLatency;let e=null;for(;cursorPositionQueue.length>0&&cursorPositionQueue[0].time<=t;)e=cursorPositionQueue.shift();e&&(renderedCursorPosition={x:e.x,y:e.y},testAreaSVG.select("#rendered-cursor").attr("cx",renderedCursorPosition.x).attr("cy",renderedCursorPosition.y)),requestAnimationFrame(updateRenderedCursor)}function processDelayedClick(){if(pendingClickEvent){const{x:t,y:e}=pendingClickEvent;fittsTest.mouseClicked(t,e),pendingClickEvent=null}}function v(t){return"rgb("+clampInt(0,255,t/MAX_SPEED*255)+", 0, 0)"}function randomAB(t,e){return t+Math.random()*(e-t)}function mouseMoved(){var t=d3.svg.mouse(this);const e=Date.now();cursorPositionQueue.push({x:t[0],y:t[1],time:e}),fittsTest.mouseMoved(t[0],t[1])}function mouseClicked(){var t=d3.svg.mouse(this);pendingClickEvent={x:t[0],y:t[1]},clickTimeout&&clearTimeout(clickTimeout),clickTimeout=setTimeout(processDelayedClick,cursorLatency)}function distance(t,e){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(Math.pow(n,2)+Math.pow(i,2))}function clampInt(t,e,n){return Math.min(e,Math.max(t,Math.floor(n)))}function shannon(t,e){return Math.log(t/e+1)/Math.log(2)}function project(t,e,n){var i=minus(e,t),s=dot(i,i);if(0==s)return t;var r=dot(minus(n,t),i)/s;return{x:t.x+r*i.x,y:t.y+r*i.y,t:r}}function dot(t,e){return t.x*e.x+t.y*e.y}function isLeft(t,e,n){return(e.x-t.x)*(n.y-t.y)-(e.y-t.y)*(n.x-t.x)>=0?1:-1}function minus(t,e){return{x:t.x-e.x,y:t.y-e.y}}function sign(t){return t>=0?1:-1}function cov(t,e,n){if(t.length<=1)return 0;for(var i=mean(t,e),s=mean(t,n),r=0,o=0;o<t.length;o++)r+=(e(t[o])-i)*(n(t[o])-s);return r/(t.length-1)}function variance(t,e){return cov(t,e,e)}function mean(t,e){for(var n=0,i=0;i<t.length;i++)n+=e(t[i]);return n/t.length}function bgRect(t,e){return t.append("rect").attr("cx",0).attr("cy",0).attr("width",e.width).attr("height",e.height).attr("class","back")}function updateCursorLatency(t){cursorLatency=parseInt(t),document.getElementById("latency-value").textContent=t+"ms"}function startTimer(){function t(n){e||(e=n),elapsed=n-e,timer.innerText=(elapsed/1e3).toFixed(2),fittsTest.active?window.requestAnimationFrame(t):console.log("stop timer")}let e=null;console.log("start timer"),window.requestAnimationFrame(t)}function startExperience(){resetTrialData();let t=conditionSelect.value;if(console.log("start experience, condition: "+t),"1"===t)fittsTest.advanceParams(300,75);else if("2"===t)fittsTest.advanceParams(300,38);else if("3"===t)fittsTest.advanceParams(300,20);else{if("4"!==t)return;fittsTest.advanceParams(60,20)}startScreen.style.display="none",experienceScreen.style.display="",createRenderedCursor(),requestAnimationFrame(updateRenderedCursor)}function endExperience(){experienceScreen.style.display="none",startScreen.style.display="";for(var t=[],e=0;e<fittsTest.clickHistory.length;e++){var n=(v=fittsTest.clickHistory[e]).distance.toString()+v.width.toString();t[n]||(t[n]=[]);var i=project(v.start,v.target,v.hit),s=(distance(i,v.start),sign(i.t),distance(i,v.hit)*isLeft(v.start,v.target,v.hit));v.realDistance=distance(v.start,v.hit),v.projectedHitOffsetX=distance(i,v.target)*sign(i.t-1),v.projectedHitOffsetY=s,t[n].push(v)}var r=[];for(var o in t){var a=t[o];if(!(a.length<3)){var c=4.133*Math.sqrt(variance(a,function(t){return t.projectedHitOffsetX})),u=4.133*Math.sqrt(variance(a,function(t){return t.projectedHitOffsetY})),l=Math.min(c,u),d=mean(a,function(t){return t.realDistance}),m=d,g=shannon(m,l);console.log(`We ${l} De ${m} IDe ${g} xeff ${c} yeff ${u} deff ${d}`);var h=0,f=0;for(e=0;e<a.length;e++){var v;(v=a[e]).IDe=g,v.throughput=v.IDe/v.time*1e3,h+=v.throughput,f+=v.time,r.push(v)}var y=h/a.length;console.log(`Average throughput: ${y} totaltime ${f}`),fittsTest.lastIDe=g,fittsTest.lastTP=y}}let p=(elapsed/1e3).toFixed(2),T=fittsID.toFixed(2),x=fittsTest.lastIDe.toFixed(2),P=fittsTest.lastTP.toFixed(2),E=(fittsTest.currentCount,fittsTest.clicksTotal),I=fittsTest.clicksOnTarget,C=fittsTest.targetEntries;startText.innerText=`#${trialNum} C:${conditionSelect.value} TTC:${p}s ID:${T} IDe:${x} TP:${P} CT:${E} TE:${C}\n`+startText.innerText,submitForm(trialNum,conditionSelect.value,T,x,P,p,E,I,C),trialNum+=1,fittsTest.currentPosition=0,fittsTest.currentCount=0,fittsTest.miss=0,fittsTest.active=!1,fittsTest.clicksTotal=0,fittsTest.clicksOnTarget=0,fittsTest.targetEntries=1,fittsTest.isInsideTarget=!1,timer.innerText="",testAreaSVG.selectAll("line").remove(),testAreaSVG.select("#rendered-cursor").remove()}function submitForm(t,e,n,i,s,r,o,a,c){const u=document.getElementById("bootstrapForm");u.dataset.submitHandlerAdded||(u.addEventListener("submit",t=>{t.preventDefault();const e=new FormData(u);fetch(u.action,{method:"POST",body:e,mode:"no-cors"}).then(()=>{console.log("Form submitted successfully")}).catch(t=>{console.error("Error submitting form:",t)})}),u.dataset.submitHandlerAdded="true"),document.getElementById("device_os").value=navigator.platform,document.getElementById("device_browser").value=navigator.userAgent,document.getElementById("participant_id").value=document.getElementById("button-pad-id").value,document.getElementById("trial_num").value=t,document.getElementById("condition_num").value=e,document.getElementById("index_of_difficulty").value=n,document.getElementById("effective_id").value=i,document.getElementById("throughput").value=s,document.getElementById("time_to_complete").value=r,document.getElementById("clicks_total").value=o,document.getElementById("clicks_on_target").value=a,document.getElementById("target_entries").value=c,document.getElementById("drag_count").value=dragCount}function initButtonPad(){const t=document.getElementById("button-pad-id");document.querySelectorAll(".button-pad button").forEach(e=>{e.addEventListener("click",()=>{"C"===e.textContent?t.value="":t.value.length<2&&(t.value+=e.textContent)})})}var testDimension=makeDimension(620,400,30,30,30,30),MAX_SPEED=2,elapsed=0,fittsID=0,trialNum=1;let stopTimeout,isMoving=!1,dragCount=0,lastMousePosition={x:null,y:null},cursorLatency=100,cursorPositionQueue=[],lastRenderTime=0,renderedCursorPosition={x:0,y:0},pendingClickEvent=null,clickTimeout=null;const experienceScreen=document.getElementById("experience-screen"),startScreen=document.getElementById("start-screen"),startButton=document.getElementById("start-button"),timer=document.getElementById("timer"),startText=document.getElementById("start-text"),conditionSelect=document.getElementById("condition");document.addEventListener("mousemove",t=>{const e={x:t.clientX,y:t.clientY};lastMousePosition.x===e.x&&lastMousePosition.y===e.y||(lastMousePosition=e,isMoving||(isMoving=!0,dragCount++,console.log(`Drag Count: ${dragCount}`)),clearTimeout(stopTimeout),stopTimeout=setTimeout(()=>{isMoving=!1},100))});var fittsTest={target:{x:0,y:0,r:10},start:{x:0,y:0,t:0},last:{},isoPositions:[],currentPosition:0,currentCount:0,miss:0,isoLimits:{minD:120,maxD:300,minW:10,maxW:100},isoParams:{num:9,distance:200,width:50,randomize:!0},active:!1,clicksTotal:0,clicksOnTarget:0,targetEntries:1,isInsideTarget:!1,clickHistory:[],lastIDe:0,lastTP:0,colour:d3.scale.category10(),generateTarget:function(){this.target=this.isoPositions[this.currentPosition],this.target.distance=this.isoParams.distance;var t=testAreaSVG.selectAll("#target").data([this.target]),e=function(t){t.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("r",function(t){return t.w/2})};t.enter().append("circle").attr("id","target").style("fill","red").style("opacity",.5).call(e),t.transition().call(e)},updateISOCircles:function(){this.generateISOPositions(this.isoParams.num,this.isoParams.distance,this.isoParams.width);var t=testAreaSVG.selectAll("circle").data(this.isoPositions),e=function(t){t.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("r",function(t){return t.w/2})};t.enter().append("circle").attr("class","iso").call(e),t.transition().call(e),t.exit().transition().attr("r",0).remove(),this.generateTarget()},generateISOPositions:function(t,e,n){this.isoPositions=[];for(var i=0;i<t;i++)this.isoPositions[i]={x:testDimension.cx+e/2*Math.cos(2*Math.PI*i/t),y:testDimension.cy+e/2*Math.sin(2*Math.PI*i/t),w:n}},removeTarget:function(){testAreaSVG.selectAll("#target").data([]).exit().remove()},mouseClicked:function(t,e){var n=distance({x:t,y:e},this.target)<this.target.w/2;this.clicksTotal++,n?(this.clicksOnTarget++,this.active||(console.log("start active"),startTimer(),this.active=!0),this.addDataPoint({start:this.start,target:this.target,path:this.currentPath,hit:{x:t,y:e,t:(new Date).getTime()}}),this.currentCount++,this.currentPosition=(this.currentPosition+Math.ceil(this.isoPositions.length/2))%this.isoPositions.length,this.removeTarget(),this.generateTarget(),9===this.currentCount&&(this.active=!1,endExperience()),this.last={x:t,y:e,t:(new Date).getTime()},this.start=this.last):this.miss++},mouseMoved:function(t,e){if(this.active){if(t==this.last.x&&e==this.last.y)return;const n=distance({x:t,y:e},this.target)<this.target.w/2;n&&!this.isInsideTarget?(this.targetEntries++,this.isInsideTarget=!0,console.log("Target entered: "+this.targetEntries)):n||(this.isInsideTarget=!1),this.last={x:t,y:e,t:(new Date).getTime()}}},advanceParams:function(t,e){console.log("advance params, current count: "+this.currentCount),this.isoParams.distance=t,this.isoParams.width=e,this.clickHistory=[],fittsID=Math.log2(t/e+1),console.log(`dist ${t} width ${e} fitts id ${fittsID}`),this.updateISOCircles()},addDataPoint:function(t){if(0!=this.active){var e=t.hit.t-t.start.t;if(e<1e4){var n=distance(t.target,t.start),i=shannon(n,t.target.w);this.clickHistory.push({time:e,distance:t.target.distance,width:t.target.w,hit:t.hit,start:t.start,target:t.target,path:t.path}),console.log(`id ${i} dt ${e} dist ${n}`)}}}},testAreaSVG=d3.select("#test-area").append("svg").attr("width",testDimension.width).attr("height",testDimension.height).style("pointer-events","all").on("mousemove",mouseMoved).on("mousedown",mouseClicked).call(bgRect,testDimension);window.addEventListener("load",function(){initButtonPad(),document.getElementById("latency-slider")&&(document.getElementById("latency-slider").value=cursorLatency,document.getElementById("latency-value").textContent=cursorLatency+"ms")}),startButton.addEventListener("click",startExperience);