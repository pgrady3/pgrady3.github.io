"use strict";function makeDimension(t,e,i,n,s,a){return{width:t,height:e,innerWidth:t-(a+n),innerHeight:e-(i+s),top:i,right:n,bottom:s,left:a,cx:(t-(a+n))/2+a,cy:(e-(i+s))/2+i}}function rHit(t,e){return plotHitsDimension.innerWidth/2/e*t}function resetTrialData(){isMoving=!1,dragCount=0,fittsTest.totalCursorDistance=0,clearTimeout(stopTimeout),console.log("Trial data reset. Drag count is now 0.")}function v(t){return"rgb("+clampInt(0,255,t/MAX_SPEED*255)+", 0, 0)"}function randomAB(t,e){return t+Math.random()*(e-t)}function mouseMoved(){var t=d3.svg.mouse(this);fittsTest.mouseMoved(t[0],t[1])}function mouseClicked(){var t=d3.svg.mouse(this);fittsTest.mouseClicked(t[0],t[1])}function distance(t,e){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(Math.pow(i,2)+Math.pow(n,2))}function clampInt(t,e,i){return Math.min(e,Math.max(t,Math.floor(i)))}function shannon(t,e){return Math.log(t/e+1)/Math.log(2)}function project(t,e,i){var n=minus(e,t),s=dot(n,n);if(0==s)return t;var a=dot(minus(i,t),n)/s;return{x:t.x+a*n.x,y:t.y+a*n.y,t:a}}function dot(t,e){return t.x*e.x+t.y*e.y}function isLeft(t,e,i){return(e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x)>=0?1:-1}function minus(t,e){return{x:t.x-e.x,y:t.y-e.y}}function sign(t){return t>=0?1:-1}function cov(t,e,i){if(t.length<=1)return 0;for(var n=mean(t,e),s=mean(t,i),a=0,r=0;r<t.length;r++)a+=(e(t[r])-n)*(i(t[r])-s);return a/(t.length-1)}function variance(t,e){return cov(t,e,e)}function mean(t,e){for(var i=0,n=0;n<t.length;n++)i+=e(t[n]);return i/t.length}function bgRect(t,e){return t.append("rect").attr("cx",0).attr("cy",0).attr("width",e.width).attr("height",e.height).attr("class","back")}function startTimer(){function t(i){e||(e=i),elapsed=i-e,timer.innerText=(elapsed/1e3).toFixed(2),fittsTest.active?window.requestAnimationFrame(t):console.log("stop timer")}let e=null;console.log("start timer"),window.requestAnimationFrame(t)}function startExperience(){resetTrialData();let t=conditionSelect.value;if(console.log("start experience, condition: "+t),"1"===t)fittsTest.advanceParams(300,75);else if("2"===t)fittsTest.advanceParams(300,38);else if("3"===t)fittsTest.advanceParams(300,20);else{if("4"!==t)return;fittsTest.advanceParams(60,20)}startScreen.style.display="none",experienceScreen.style.display=""}function endExperience(){experienceScreen.style.display="none",startScreen.style.display="";for(var t=[],e=0;e<fittsTest.clickHistory.length;e++){var i=(v=fittsTest.clickHistory[e]).distance.toString()+v.width.toString();t[i]||(t[i]=[]);var n=project(v.start,v.target,v.hit),s=(distance(n,v.start),sign(n.t),distance(n,v.hit)*isLeft(v.start,v.target,v.hit));v.realDistance=distance(v.start,v.hit),v.projectedHitOffsetX=distance(n,v.target)*sign(n.t-1),v.projectedHitOffsetY=s,t[i].push(v)}var a=[];for(var r in t){var o=t[r];if(!(o.length<3)){var c=4.133*Math.sqrt(variance(o,function(t){return t.projectedHitOffsetX})),l=4.133*Math.sqrt(variance(o,function(t){return t.projectedHitOffsetY})),u=Math.min(c,l),d=mean(o,function(t){return t.realDistance}),m=d,h=shannon(m,u);console.log(`We ${u} De ${m} IDe ${h} xeff ${c} yeff ${l} deff ${d}`);var g=0,f=0;for(e=0;e<o.length;e++){var v;(v=o[e]).IDe=h,v.throughput=v.IDe/v.time*1e3,g+=v.throughput,f+=v.time,a.push(v)}var y=g/o.length;console.log(`Average throughput: ${y} totaltime ${f}`),fittsTest.lastIDe=h,fittsTest.lastTP=y}}let T=(elapsed/1e3).toFixed(2),x=fittsID.toFixed(2),p=fittsTest.lastIDe.toFixed(2),I=fittsTest.lastTP.toFixed(2),E=(fittsTest.currentCount,fittsTest.clicksTotal),D=fittsTest.clicksOnTarget,P=fittsTest.targetEntries,w=fittsTest.totalCursorDistance.toFixed(1);startText.innerText=`#${trialNum} C:${conditionSelect.value} TTC:${T}s ID:${x} IDe:${p} TP:${I} CT:${E} TE:${P} TCD:${w}px\n`+startText.innerText,submitForm(trialNum,conditionSelect.value,x,p,I,T,E,D,P,w),trialNum+=1,fittsTest.currentPosition=0,fittsTest.currentCount=0,fittsTest.miss=0,fittsTest.active=!1,fittsTest.clicksTotal=0,fittsTest.clicksOnTarget=0,fittsTest.targetEntries=1,fittsTest.isInsideTarget=!1,timer.innerText="",testAreaSVG.selectAll("line").remove()}function submitForm(t,e,i,n,s,a,r,o,c,l){const u=document.getElementById("bootstrapForm");u.dataset.submitHandlerAdded||(u.addEventListener("submit",t=>{t.preventDefault();const e=new FormData(u);fetch(u.action,{method:"POST",body:e,mode:"no-cors"}).then(()=>{console.log("Form submitted successfully")}).catch(t=>{console.error("Error submitting form:",t)})}),u.dataset.submitHandlerAdded="true"),document.getElementById("device_os").value=navigator.platform,document.getElementById("device_browser").value=navigator.userAgent,document.getElementById("participant_id").value=document.getElementById("button-pad-id").value,document.getElementById("trial_num").value=t,document.getElementById("condition_num").value=e,document.getElementById("index_of_difficulty").value=i,document.getElementById("effective_id").value=n,document.getElementById("throughput").value=s,document.getElementById("time_to_complete").value=a,document.getElementById("clicks_total").value=r,document.getElementById("clicks_on_target").value=o,document.getElementById("target_entries").value=c,document.getElementById("drag_count").value=dragCount,document.getElementById("total_cursor_distance").value=l,u.dispatchEvent(new Event("submit",{cancelable:!0}))}function initButtonPad(){const t=document.getElementById("button-pad-id");document.querySelectorAll(".button-pad button").forEach(e=>{e.addEventListener("click",()=>{"C"===e.textContent?t.value="":t.value.length<2&&(t.value+=e.textContent)})})}var testDimension=makeDimension(620,400,30,30,30,30),MAX_SPEED=2,elapsed=0,fittsID=0,trialNum=1;let stopTimeout,isMoving=!1,dragCount=0,lastMousePosition={x:null,y:null};const experienceScreen=document.getElementById("experience-screen"),startScreen=document.getElementById("start-screen"),startButton=document.getElementById("start-button"),timer=document.getElementById("timer"),startText=document.getElementById("start-text"),conditionSelect=document.getElementById("condition");document.addEventListener("mousemove",()=>{const t={x:event.clientX,y:event.clientY};lastMousePosition.x===t.x&&lastMousePosition.y===t.y||(lastMousePosition=t,isMoving||(isMoving=!0,dragCount++,console.log(`Drag Count: ${dragCount}`)),clearTimeout(stopTimeout),stopTimeout=setTimeout(()=>{isMoving=!1},100))});var fittsTest={target:{x:0,y:0,r:10},start:{x:0,y:0,t:0},last:{},isoPositions:[],currentPosition:0,currentCount:0,miss:0,isoLimits:{minD:120,maxD:300,minW:10,maxW:100},isoParams:{num:9,distance:200,width:50,randomize:!0},active:!1,clicksTotal:0,clicksOnTarget:0,targetEntries:1,isInsideTarget:!1,totalCursorDistance:0,clickHistory:[],lastIDe:0,lastTP:0,colour:d3.scale.category10(),generateTarget:function(){this.target=this.isoPositions[this.currentPosition],this.target.distance=this.isoParams.distance;var t=testAreaSVG.selectAll("#target").data([this.target]),e=function(t){t.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("r",function(t){return t.w/2})};t.enter().append("circle").attr("id","target").style("fill","red").call(e),t.transition().call(e)},updateISOCircles:function(){this.generateISOPositions(this.isoParams.num,this.isoParams.distance,this.isoParams.width);var t=testAreaSVG.selectAll("circle").data(this.isoPositions),e=function(t){t.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("r",function(t){return t.w/2})};t.enter().append("circle").attr("class","iso").call(e),t.transition().call(e),t.exit().transition().attr("r",0).remove(),this.generateTarget()},generateISOPositions:function(t,e,i){this.isoPositions=[];for(var n=0;n<t;n++)this.isoPositions[n]={x:testDimension.cx+e/2*Math.cos(2*Math.PI*n/t),y:testDimension.cy+e/2*Math.sin(2*Math.PI*n/t),w:i}},removeTarget:function(){testAreaSVG.selectAll("#target").data([]).exit().remove()},mouseClicked:function(t,e){var i=distance({x:t,y:e},this.target)<this.target.w/2;this.clicksTotal++,i?(this.clicksOnTarget++,this.active||(console.log("start active"),startTimer(),this.active=!0),this.addDataPoint({start:this.start,target:this.target,path:this.currentPath,hit:{x:t,y:e,t:(new Date).getTime()}}),this.currentCount++,this.currentPosition=(this.currentPosition+Math.ceil(this.isoPositions.length/2))%this.isoPositions.length,this.removeTarget(),this.generateTarget(),9===this.currentCount&&(this.active=!1,endExperience()),this.last={x:t,y:e,t:(new Date).getTime()},this.start=this.last):this.miss++},mouseMoved:function(t,e){if(this.active){if(t==this.last.x&&e==this.last.y)return;if(void 0!==this.last.x&&void 0!==this.last.y){const i=distance({x:t,y:e},{x:this.last.x,y:this.last.y});this.totalCursorDistance+=i}const i=distance({x:t,y:e},this.target)<this.target.w/2;i&&!this.isInsideTarget?(this.targetEntries++,this.isInsideTarget=!0,console.log("Target entered: "+this.targetEntries)):i||(this.isInsideTarget=!1),this.last={x:t,y:e,t:(new Date).getTime()}}},advanceParams:function(t,e){console.log("advance params, current count: "+this.currentCount),this.isoParams.distance=t,this.isoParams.width=e,this.clickHistory=[],fittsID=Math.log2(t/e+1),console.log(`dist ${t} width ${e} fitts id ${fittsID}`),this.updateISOCircles()},addDataPoint:function(t){if(0!=this.active){var e=t.hit.t-t.start.t;if(e<1e4){var i=distance(t.target,t.start),n=shannon(i,t.target.w);this.clickHistory.push({time:e,distance:t.target.distance,width:t.target.w,hit:t.hit,start:t.start,target:t.target,path:t.path}),console.log(`id ${n} dt ${e} dist ${i}`)}}}},testAreaSVG=d3.select("#test-area").append("svg").attr("width",testDimension.width).attr("height",testDimension.height).style("pointer-events","all").on("mousemove",mouseMoved).on("mousedown",mouseClicked).call(bgRect,testDimension);window.addEventListener("load",initButtonPad),startButton.addEventListener("click",startExperience);