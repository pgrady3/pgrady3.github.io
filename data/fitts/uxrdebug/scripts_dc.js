function loadChimes(){for(var e=1;e<=1;e++)successChimes.push(new Audio("audio/chime_"+e+".mp3"));errorChime=new Audio("audio/error_1.mp3")}function playChime(e){if(e){let e=successChimes[Math.floor(rng.random()*successChimes.length)];console.log(`Playing chime ${e.src}`),e.pause(),e.currentTime=0,e.play()}else errorChime.play()}function checkClick(e,t){switch(t){case"single":case"directtouch":return 1===e.which;case"double":return 2===e.detail;case"secondary":return 3===e.which}return!1}function getRandomRange(e,t){return rng.random()*(t-e+1)+e}function setBackgroundTimer(){document.getElementById("container-outline").style.backgroundColor="#ff7573",clearTimeout(backgroundTimer),playChime(!1),backgroundTimer=setTimeout(()=>{document.getElementById("container-outline").style.backgroundColor="#fafafa"},2e3)}function moveTargetButton(){const e=BUTTON_SIZES[Math.floor(rng.random()*BUTTON_SIZES.length)],t=window.innerWidth*e,n=(1-SCREEN_AREA_USED)/2,o=n*window.innerWidth+t/2,l=(1-n)*window.innerWidth-t/2,i=n*window.innerHeight+t/2,r=(1-n)*window.innerHeight-t/2,s=getRandomRange(.01,BUTTON_RESPAWN_MAX_RAD)*window.innerWidth;for(var c=0;;c++){const e=getRandomRange(0,2*Math.PI);if(newX=lastX+Math.cos(e)*s,newY=lastY+Math.sin(e)*s,newX>=o&&newX<=l&&newY>=i&&newY<=r)break;if(c>100){newX=getRandomRange(o,l),newY=getRandomRange(i,r);break}}targetButton=document.getElementById("target-button"),targetButton.style.left=`${newX}px`,targetButton.style.top=`${newY}px`,targetButton.style.height=`${t}px`,targetButton.style.width=`${t}px`,lastX=newX,lastY=newY}function startExperience(){rng=new RandomGenerator,loadChimes(),successfulClicks=0,moveTargetButton(),"timer"===CLICK_METHOD?(setInterval(moveTargetButton,MOVE_INTERVAL_TIMER_MS),document.addEventListener("mousemove",setBackgroundTimer),document.addEventListener("mousedown",setBackgroundTimer)):"hold"===CLICK_METHOD?(document.getElementById("target-button").addEventListener("mousedown",button_handler),document.getElementById("target-button").addEventListener("mouseup",button_handler),document.getElementById("target-button").addEventListener("mouseleave",button_handler)):"directtouch"===CLICK_METHOD?(document.addEventListener("click",button_handler),document.addEventListener("contextmenu",button_handler)):(document.getElementById("target-button").addEventListener("click",button_handler),document.getElementById("target-button").addEventListener("contextmenu",button_handler));const e=100*SCREEN_AREA_USED;document.getElementById("container-outline").style.width=`${e}vw`,document.getElementById("container-outline").style.height=`${e}vh`,document.getElementById("start-screen").style.display="none",document.getElementById("experience-screen").style.display=""}function setExperienceTitle(e,t){document.getElementById("text-top-left").innerHTML=e,document.getElementById("start-title").innerHTML=e,document.getElementById("start-explanation").innerHTML=t,document.title=e}function highlightRandomPhraseScroll(){let e=document.querySelectorAll(".scroll-text");e=Array.from(e).slice(1,-1);const t=e[Math.floor(rng.random()*e.length)],n=t.textContent.replace(/\s+/g," ").trim().split(" "),o=Math.floor(2*rng.random())+3,l=Math.floor(rng.random()*(n.length-o)),i=l+o,r=document.createElement("span");r.classList.add("highlight"),r.textContent=n.slice(l,i).join(" ");const s=n.slice(0,l).join(" "),c=n.slice(i).join(" ");if(t.innerHTML=`${s} ${r.outerHTML} ${c}`,console.log("Highlighting: "+r.innerHTML),isHighlightInTargetbox()&&(removeHighlight(),highlightRandomPhraseScroll()),showUpDownArrows(),successfulClicks>=MAX_SCROLL_TRIALS){document.getElementById("start-screen").style.display="",document.getElementById("scroll-body").style.display="none",removeHighlight(),document.getElementById("scroll-body").removeEventListener("scroll",onScrollCallback);let e=document.getElementById("start-text"),t=(elapsed/1e3).toFixed(2);e.innerText=`#${trialNum}, TTC: ${t}s\n`+e.innerText,submitForm(trialNum,t),trialNum+=1}}function removeHighlight(){const e=document.querySelectorAll(".highlight");for(const t of e){const e=t.parentNode;e.innerHTML=e.textContent}}function isHighlightInTargetbox(){if(highlights=document.querySelectorAll(".highlight"),targetbox=document.getElementById("targetbox"),0===highlights.length)return!1;const e=highlights[0].getBoundingClientRect(),t=targetbox.getBoundingClientRect();return e.top>=t.top&&e.bottom<=t.bottom}function showUpDownArrows(){if(highlights=document.querySelectorAll(".highlight"),targetbox=document.getElementById("targetbox"),0===highlights.length)return;const e=highlights[0].getBoundingClientRect(),t=targetbox.getBoundingClientRect();t.bottom,t.top;e.bottom>t.bottom?(document.getElementById("targetarrowup").style.display="none",document.getElementById("targetarrowdown").style.display=""):e.top<t.top?(document.getElementById("targetarrowup").style.display="",document.getElementById("targetarrowdown").style.display="none"):(document.getElementById("targetarrowup").style.display="none",document.getElementById("targetarrowdown").style.display="none")}function onScrollCallback(){clearTimeout(highlightTimeout),showUpDownArrows(),isHighlightInTargetbox()&&(highlightTimeout=setTimeout(()=>{isHighlightInTargetbox()&&(successfulClicks+=1,console.log(`click ${successfulClicks}`),removeHighlight(),highlightRandomPhraseScroll(),playChime(!0))},300))}function startScrollExperience(){rng=new RandomGenerator,successfulClicks=0,loadChimes(),document.getElementById("start-screen").style.display="none",document.getElementById("scroll-body").style.display="",document.getElementById("scroll-container").addEventListener("scroll",onScrollCallback),document.getElementById("scroll-container").scrollTop=0,highlightRandomPhraseScroll(),startTimer()}function highlightRandomPhraseSelection(){let e=document.querySelectorAll(".selection-text");e=Array.from(e);const t=parseFloat(window.getComputedStyle(e[0]).lineHeight);for(;;){let n=e[Math.floor(rng.random()*e.length)],o=n.textContent.replace(/\s+/g," ").trim(),l=o.split(" "),i=Math.floor(3*rng.random())+3,r=Math.floor(rng.random()*(l.length-i)),s=r+i,c=document.createElement("span");c.classList.add("highlight"),c.textContent=l.slice(r,s).join(" ");let a=l.slice(0,r).join(" "),d=l.slice(s).join(" ");n.innerHTML=a+" "+c.outerHTML+" "+d;const u=n.querySelector(".highlight").getBoundingClientRect().height;if(console.log("Highlighting phrase: "+c.textContent),u<=t)break;n.textContent=o}}function selectionChangedHandler(){const e=window.getSelection().toString(),t=document.querySelector(".highlight");if(null===t)return;const n=t.textContent.slice(1,-1),o=e.indexOf(n);if(o>=0&&o<=2&&o+n.length+2>=e.length&&(console.log("User selected the highlighted text! Getting a new phrase."),removeHighlight(),highlightRandomPhraseSelection(),playChime(!0),successfulClicks+=1,successfulClicks>=MAX_SELECTION_TRIALS)){document.getElementById("start-screen").style.display="",document.getElementById("textselection-body").style.display="none",removeHighlight(),document.removeEventListener("mouseup",selectionChangedHandler);let e=document.getElementById("start-text"),t=(elapsed/1e3).toFixed(2);e.innerText=`#${trialNum}, TTC: ${t}s\n`+e.innerText,submitForm(trialNum,t),trialNum+=1}}function removeHighlight(){const e=document.querySelectorAll(".highlight");for(const t of e){const e=t.parentNode,n=window.getSelection();e.innerHTML=e.textContent,n.removeAllRanges()}}function removeExcessParagraphs(){const e=document.querySelectorAll("#textselection-container p"),t=document.getElementById("scroller");for(let n=e.length-1;n>=0;n--){t.scrollHeight,t.clientHeight;const o=e[n];t.scrollHeight>t.clientHeight&&(o.parentNode.removeChild(o),console.log("Removed paragraph "+n))}}function startTextSelectionExperience(){rng=new RandomGenerator,successfulClicks=0,loadChimes(),document.getElementById("start-screen").style.display="none",document.getElementById("textselection-body").style.display="",removeExcessParagraphs(),highlightRandomPhraseSelection(),document.addEventListener("mouseup",selectionChangedHandler),startTimer()}function startTimer(){function e(n){t||(t=n),elapsed=n-t,document.getElementById("text-top-left").innerText=(elapsed/1e3).toFixed(2),"Scroll"==EXPERIENCE_NAME&&successfulClicks>=MAX_SCROLL_TRIALS||"Text Selection"==EXPERIENCE_NAME&&successfulClicks>=MAX_SELECTION_TRIALS?console.log("stop timer"):window.requestAnimationFrame(e)}let t=null;console.log("start timer"),window.requestAnimationFrame(e)}function submitForm(e,t){const n=document.getElementById("bootstrapForm");n.dataset.submitHandlerAdded||(n.addEventListener("submit",e=>{e.preventDefault();const t=new FormData(n);fetch(n.action,{method:"POST",body:t,mode:"no-cors"}).then(()=>{console.log("Form submitted successfully")}).catch(e=>{console.error("Error submitting form:",e)})}),n.dataset.submitHandlerAdded="true"),document.getElementById("device_os").value=navigator.platform,document.getElementById("device_browser").value=navigator.userAgent,document.getElementById("participant_id").value=document.getElementById("button-pad-id").value,document.getElementById("trial_num").value=e,document.getElementById("time_to_complete").value=t}function initButtonPad(){const e=document.getElementById("button-pad-id");document.querySelectorAll(".button-pad button").forEach(t=>{t.addEventListener("click",()=>{"C"===t.textContent?e.value="":e.value.length<2&&(e.value+=t.textContent)})})}let BUTTON_SIZES=[.01,.02,.1],SCREEN_AREA_USED=.9,BUTTON_RESPAWN_MAX_RAD=.5;const HOLD_DURATION_MS=1e3,MOVE_INTERVAL_TIMER_MS=3e3,MAX_SCROLL_TRIALS=6,MAX_SELECTION_TRIALS=6;let timer,backgroundTimer,highlightTimeout,errorChime,rng,successfulClicks=0,lastX=window.innerWidth/2,lastY=window.innerHeight/2,successfulHold=!1,successChimes=[],elapsed=0,trialNum=1;class RandomGenerator{constructor(e){this.seed=void 0!==e?e:Math.floor(Math.random()*Math.pow(2,32)),this.a=1664525,this.c=1013904223,this.m=Math.pow(2,32),this.x=this.seed}nextInt(){return this.x=(this.a*this.x+this.c)%this.m,this.x}random(){return this.nextInt()/this.m}}const button_handler=e=>{if(e.stopPropagation(),e.preventDefault(),("single"===CLICK_METHOD||"double"===CLICK_METHOD||"secondary"===CLICK_METHOD||"directtouch"===CLICK_METHOD)&&checkClick(e,CLICK_METHOD))return moveTargetButton(),successfulClicks+=1,console.log(`click ${successfulClicks}`),void playChime(!0);if("hold"===CLICK_METHOD){if(1!=e.which)return;"mousedown"===event.type?(console.log("MouseDown event"),successfulHold=!1,e.target.classList.remove("hold-long"),e.target.classList.add("hold-short"),timer=setTimeout(()=>{console.log("Button has been held for 1 second"),successfulHold=!0,e.target.classList.add("hold-long"),e.target.classList.remove("hold-short")},HOLD_DURATION_MS)):"mouseup"!==event.type&&"mouseleave"!==event.type||(console.log("MouseUp/MouseLeave event"),clearTimeout(timer),e.target.classList.remove("hold-long"),e.target.classList.remove("hold-short"),successfulHold&&(moveTargetButton(),successfulClicks+=1,playChime(!0),console.log(`click ${successfulClicks}`)))}};window.addEventListener("load",initButtonPad);